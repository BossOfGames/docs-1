"use strict";(self.webpackChunkphpvms_docs=self.webpackChunkphpvms_docs||[]).push([[7010],{4137:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},p="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),p=u(n),d=r,h=p["".concat(s,".").concat(d)]||p[d]||m[d]||l;return n?a.createElement(h,o(o({ref:t},c),{},{components:n})):a.createElement(h,o({ref:t},c))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,o=new Array(l);o[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[p]="string"==typeof e?e:r,o[1]=i;for(var u=2;u<l;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4327:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>l,metadata:()=>i,toc:()=>u});var a=n(7462),r=(n(7294),n(4137));const l={id:"rules",title:"Custom Rules"},o=void 0,i={unversionedId:"acars/rules",id:"acars/rules",title:"Custom Rules",description:"For users with Premium, you can create their own rules, in Javascript. See Custom Packaging on how to create a distribution for your VA, which can include rules, sounds and callbacks.",source:"@site/docs/acars/rules.mdx",sourceDirName:"acars",slug:"/acars/rules",permalink:"/acars/rules",draft:!1,editUrl:"https://github.com/phpvms/docs/tree/master/docs/acars/rules.mdx",tags:[],version:"current",frontMatter:{id:"rules",title:"Custom Rules"}},s={},u=[{value:"How Rules Work",id:"how-rules-work",level:2},{value:"PIREP Object Fields",id:"pirep-object-fields",level:3},{value:"ACARS Object Fields",id:"acars-object-fields",level:3},{value:"Rule Definitions",id:"rule-definitions",level:2},{value:"General Notes",id:"general-notes",level:4},{value:"Methods Available",id:"methods-available",level:2},{value:"Log/LogDebug/LogError()",id:"loglogdebuglogerror",level:4},{value:"ViolatedAfterDelay(name, timeout, callback)",id:"violatedafterdelayname-timeout-callback",level:4},{value:"Acars.Get(name) / Acars.Set(name, value)",id:"acarsgetname--acarssetname-value",level:4},{value:"Testing",id:"testing",level:2}],c={toc:u},p="wrapper";function m(e){let{components:t,...n}=e;return(0,r.kt)(p,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"For users with Premium, you can create their own rules, in Javascript. See ",(0,r.kt)("a",{parentName:"p",href:"/acars/packaging"},"Custom Packaging")," on how to create a distribution for your VA, which can include rules, sounds and callbacks."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"how-rules-work"},"How Rules Work"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The rules are evaluated once every second"),(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"evaluate()")," method is passed 3 peices of information:",(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"Pirep")," object - this contains all of the data about the PIREP, along with some additional information"),(0,r.kt)("li",{parentName:"ol"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"Acars"),' object - contains current "sensor" information about the aircraft'),(0,r.kt)("li",{parentName:"ol"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"PreviousAcars")," object - contains the previous sensor information")))),(0,r.kt)("p",null,"You can also store data from point in time for comparisons._createMdxContent"),(0,r.kt)("h3",{id:"pirep-object-fields"},"PIREP Object Fields"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"})),(0,r.kt)("h3",{id:"acars-object-fields"},"ACARS Object Fields"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"})),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"rule-definitions"},"Rule Definitions"),(0,r.kt)("p",null,"A rule looks like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js",metastring:"title=rules/myrule.js",title:"rules/myrule.js"},"/**\n * Rules are contained in a class. The class needs to be called Rule\n */\nexport default class MyRule {\n    /**\n     * This is required\n     * @type {{name: string, message: string, enabled: boolean, phases: string[]}}\n     */\n    meta = {\n        // A unique identifier\n        'name': 'Your Rule Name',\n\n        // Should this be run?\n        'enabled': true,\n\n        // This is the message that will show up in the log\n        'message': 'Your lights should have been on',\n\n        // The phases in which this rule should be run\n        'phases': ['takeoff', 'enroute'],\n    }\n\n    /**\n     * This is called to evaluate the rule. This should return the number of points\n     * that should be deducted\n     *\n     * @param {Object.<string, any>} pirep\n     * @param {Object.<string, any>} data\n     * @param {Object.<string, any>} previousData\n     *\n     * @returns {number}\n     */\n    evaluate(pirep, data, previousData) {\n        return 0\n    }\n}\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"meta")," - This is required so ACARS knows some basic information about your script"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"evaluate")," - Called with the current PIREP information, and the current ACARS data. This needs to return an integer value.")),(0,r.kt)("h4",{id:"general-notes"},"General Notes"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"There are no ",(0,r.kt)("inlineCode",{parentName:"li"},"setTimeout")," or ",(0,r.kt)("inlineCode",{parentName:"li"},"async"),"/",(0,r.kt)("inlineCode",{parentName:"li"},"await")," calls")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"methods-available"},"Methods Available"),(0,r.kt)("p",null,"You can also browse the built-in methods available in the ",(0,r.kt)("inlineCode",{parentName:"p"},"mocks.js")," file. They're all accessed using the ",(0,r.kt)("inlineCode",{parentName:"p"},"Acars")," namespace, which is injected into the global namespace."),(0,r.kt)("h4",{id:"loglogdebuglogerror"},"Log/LogDebug/LogError()"),(0,r.kt)("p",null,"This will log out to the ACARS log"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const some_var = 'x'\nAcars.Log('This is some information', x)\n")),(0,r.kt)("h4",{id:"violatedafterdelayname-timeout-callback"},"ViolatedAfterDelay(name, timeout, callback)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"name: This is the name of the rule"),(0,r.kt)("li",{parentName:"ul"},"timeout: In milliseconds, after how long it should be considered as violated"),(0,r.kt)("li",{parentName:"ul"},"callback: The function that checks for the violation")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'return Acars.ViolatedAfterDelay("landing_lights_on", 5000, () => {\n  if (data.GroundAltitude > 10000 && data.LandingLights) {\n    return -10;\n  }\n\n  return 0;\n})\n')),(0,r.kt)("h4",{id:"acarsgetname--acarssetname-value"},"Acars.Get(name) / Acars.Set(name, value)"),(0,r.kt)("p",null,"This can be used to store some data which will be persisted across crashes or stops/starts. This will be emptied on every new flight"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"name"),": string"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"value"),": string. You can use JSON.stringify() to store objects, but I recommend only smaller items")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const some_obj = {\n  foo: 'bar'\n}\n\nAcars.Set('myobj', JSON.stringify(some_obj))\n\n// ...\nvar retrieved_obj = JSON.parse(Acars.Get('myobj'))\n")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"testing"},"Testing"),(0,r.kt)("p",null,"What I do is create a tests folder, so it looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"rules/\n  tests/\n    lights.test.js  < will be created below\n  lights.js\n  package.json < will created below\nmanifest.json\n")),(0,r.kt)("p",null,"Create a ",(0,r.kt)("inlineCode",{parentName:"p"},"package.json")," file in the root of the ",(0,r.kt)("inlineCode",{parentName:"p"},"rules")," folder, so it looks like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "name": "VA Rules",\n  "version": "1.0.0",\n  "author": "Your Name",\n  "type": "module",\n  "scripts": {\n    "tests": "tap"\n  }\n}\n')),(0,r.kt)("p",null,"Next, grab the ",(0,r.kt)("inlineCode",{parentName:"p"},"mocks.js")," file from here. This is used to mock the methods that ACARS provides, so that in the tests, there are faked versions available. If you cloned the sample repository, this file is already there."),(0,r.kt)("p",null,"Then, install ",(0,r.kt)("a",{parentName:"p",href:"https://node-tap.org"},"tap")," using:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm install --save-dev tap\n")),(0,r.kt)("p",null,"Next, create a ",(0,r.kt)("inlineCode",{parentName:"p"},"tests/lights.test.js"),". The example shown above is the ",(0,r.kt)("inlineCode",{parentName:"p"},"Rule")," class that's being assumed to be used. The important parts are commented:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"import t from 'tap'\nimport * as Lights from '../lights.js'\nimport {createMocks} from \"./mocks.js\"\n\nt.before(createMocks)\n\nt.test('Test the lights function', t => {\n    const rule = new Lights.Rule()\n    // You can pass the data that is only relevent to your rule here in the PIREP and Data objects\n    t.equal(rule.evaluate({}, {}), 0)\n    t.end()\n})\n")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"You can use webpack and babel to create a smaller distribution, which you can then create a packaged, minimized build, which then can be used by ACARS. So you're welcome to create your rules using Typescript and transpile them.")),(0,r.kt)("p",null,"Then you can finally run your tests:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd rules\nnpm run tests\n")),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"You can use ",(0,r.kt)("a",{parentName:"p",href:"https://node-tap.org/plugins/clock"},"the clock plugin")," to fast forward time - call your rule, advance the clock, call it again and check for violations")))}m.isMDXComponent=!0}}]);